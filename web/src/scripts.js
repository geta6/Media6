$(function(){var a=new MediaStoker;$(window).trigger("ContentRequest",a);$(window).on("hashchange",function(){$(window).trigger("ContentRequest",a)});$(document).on("click",".playmedia",function(){var b=this;$(".playmedia").removeClass("playing");$(this).addClass("playing");$(window).trigger("PlayMedia",{ms:a,target:b})});$(".sort").on("click",function(){$("#navsort").slideToggle(a.param.time*2)});$(window).trigger("SessionHandler",a);$("#signout").on("click",function(b){b.preventDefault();a.huds.on("Sending...");$.ajax({url:"/sign/out",type:"POST",error:function(){a.huds.on("Sign out failure.<br>Please retry.");setTimeout(function(){a.huds.off()},1200)},success:function(c){a.huds.on("Signed out.<br>Reloading...");setTimeout(function(){if(""==location.hash){location.href="#/media"}else{location.href="#"}},1200)}})})});var MediaStoker=function(){var a=this;this.media={play:null,prev:null,next:null};this.hashtype=function(b){b=$(b);return{self:b,hash:b.attr("data-hash"),type:b.attr("data-type"),path:b.attr("data-hash")+"?type="+b.attr("data-type")}};this.param={time:120,sort:{date:false,name:false},trigger:function(){$(window).trigger("SettleDown",a)}};this.huds={on:function(b){$("#huds").html(b);$("#hud").fadeIn(a.param.time)},off:function(){$("#hud").fadeOut(a.param.time*2,function(){$("#huds").html("")})}};$(window).on("resize scroll",function(){$(window).trigger("LazyLoadQueue",event.type)});this.lazy={elements:[],loaded:0,height:0,scroll:0,threshold:50,forceload:function(){$(window).off("LazyLoadQueue");for(var b=0;b<this.elements.length;b++){var c=this.elements[b];if(false==c.done){c.done=true;this.loaded++;c.tag.style.opacity=0;c.tag.src=c.tag.getAttribute("data-original");c.tag.setAttribute("data-loaded","true");c.tag.onload=function(){this.style.opacity=1}}}},update:function(d){if(this.loaded>=this.elements.length){$(window).off("LazyLoadQueue");return false}else{if("scroll"==d){this.scroll=$(window).scrollTop()}else{if("resize"==d){this.height=$(window).height()}}}var f=this.scroll+this.height+this.threshold;var b=this.scroll-this.threshold;for(var c=0;c<this.elements.length;c++){var e=this.elements[c];if(false==e.done){if(f>e.top&&e.top>b){e.done=true;this.loaded++;e.tag.style.opacity=0;e.tag.src=e.tag.getAttribute("data-original");e.tag.setAttribute("data-loaded","true");e.tag.onload=function(){this.style.opacity=1}}}}},initialize:function(b){$(window).off("LazyLoadQueue");this.elements=[];this.loaded=0;this.height=$(window).height();this.scroll=$(window).scrollTop();return document.getElementsByTagName(b)},attach:function(h){var d=this.initialize(h);var g=0;for(var e=0;e<d.length;e++){var b=d[e];var j=$(b).offset().top;var c=$(d[e]).attr("data-loaded");if("false"==c){this.elements[g]={tag:b,top:j,done:false};g++}}this.update();var f=this;$(window).on("LazyLoadQueue",function(k,i){f.update(i)})}}};
$(window).on("SessionHandler",function(d,c){var b=c.param.sort.date;var a=c.param.sort.name;$(window).on("ResetSessionParam",function(e,f){b=c.param.sort.date;a=c.param.sort.name});$("#byname").on("click",function(){c.huds.on("Sorting...");$("#navsort").slideToggle(c.param.time*2);$("#isotope").isotope({sortBy:"name",sortAscending:a},c.param.trigger);a=!a;b=c.param.sort.date;setTimeout(function(){c.huds.off()},3000)});$("#bydate").on("click",function(){c.huds.on("Sorting...");$("#navsort").slideToggle(c.param.time*2);$("#isotope").isotope({sortBy:"date",sortAscending:b},c.param.trigger);a=c.param.sort.name;b=!b;setTimeout(function(){c.huds.off()},3000)})});
$(window).on("ContentRequest",function(c,a){if($("#authenticate").size()){$(".back").attr({href:"#"}).addClass("disable");$(".sort").hide();a.huds.on("Please sign in.");setTimeout(function(){a.huds.off()},720);$("#authenticate").on("submit",function(d){d.preventDefault();a.huds.on("Sending...");$.ajax({url:"/sign/in",type:"POST",data:{user:$("#user").val(),pass:$("#pass").val()},error:function(){a.huds.on("Auth failure.<br>Please retry.");setTimeout(function(){a.huds.off()},1200)},success:function(e){a.huds.on("Auth success!");setTimeout(function(){a.huds.on("Loading...");$("#authenticate").remove();if(""==location.hash){location.href="#/media"}else{location.href="#"}},1200)}})})}else{a.huds.on("Loading...");a.media={play:null,prev:null,next:null};var b=$("#content");b.fadeTo(a.param.time*2,0,function(){a.param.path=location.hash.substr(1);if(""==a.param.path){a.param.path="/media"}$.ajax({url:"/data"+a.param.path,type:"POST",cache:true,error:function(){},complete:function(d){if(401==d.status){b.html($(d.responseText).find("#authenticate"));$(window).trigger("ContentPrepared",a)}else{var d=JSON.parse(d.responseText);b.html(d.html);$(window).trigger("ContentPrepared",a)}}})})}});
$(window).on("ContentPrepared",function(b,a){var c=a.param.path.split("/");if("undefined"!=typeof(c[2])){$("#sidebar li").removeClass("selected");$('a[href="#/'+c[1]+"/"+c[2]+'"]').parent().addClass("selected")}c.pop();if(1<c.length){$(".back").attr({href:"#"+c.join("/")}).removeClass("disable")}else{$(".back").attr({href:"#"}).addClass("disable")}if($("#isotope").size()){$(".sort").fadeIn(a.param.time,function(){$("#isotope").isotope({itemSelector:".row",getSortData:{name:function(d){return d.attr("data-name")},date:function(d){return d.attr("data-date")}}},a.param.trigger)})}else{$(".sort, #navsort").fadeOut(a.param.time,function(){a.param.trigger()})}$(window).trigger("ResetSessionParam")});
$(window).on("PlayMedia",function(e,g){var c=g.ms;var h=g.target;var b="";if(null!=c.media.play){if(c.media.play.self[0]==h){return false}}c.media.play=c.hashtype(h);var f=$(".playmedia");for(var d=0;d<f.length;d++){var a=c.hashtype(f[d]);if(c.media.play.hash==a.hash){c.media.next=("undefined"!=typeof(f[d+1])?c.hashtype(f[d+1]):null);b=$(f[d]).find(".name").html();break}}$(".close").off("click");$(".close").on("click",function(){$(c.media.play.self).removeClass("playing");c.media.play=null;$("#media").fadeOut(c.param.time*2,function(){$("audio").attr({src:null}).remove();$("#media-audio").append($('<audio id="video" autoplay controls>')).hide();$("video").attr({src:null}).remove();$("#media-video").append($('<video id="video" autoplay controls>')).hide()})});$("#media").fadeIn(c.param.time*2,function(){switch(c.media.play.type){case"audio/mp3":$("#media-audio h1").html(b);$("#media-audio").fadeIn(c.param.time*2,function(){$("audio").attr({src:c.media.play.path}).fadeIn(c.param.time,function(){$("audio").on("ended",function(){$(window).trigger("EndMedia",{ms:c,target:"audio"})})})});break;case"video/mp4":$("#media-video h1").html(b);$("#media-video").fadeIn(c.param.time*2,function(){$("video").attr({src:c.media.play.path}).fadeIn(c.param.time*2,function(){$("video").on("ended",function(){$(window).trigger("EndMedia",{ms:c,target:"video"})})})});break}})});
$(window).on("EndMedia",function(b,c){var a=c.ms;var d=c.target;$(a.media.play.self).removeClass("playing");if("audio"==d){$("audio").off("ended");if(null==a.media.next){$("audio").fadeOut(a.param.time,function(){$("#media").slideUp(a.param.time*2)})}else{$(a.media.next.self).addClass("playing");$(window).trigger("PlayMedia",{ms:a,target:a.media.next.self})}}else{if("video"==d){$("video").off("ended");if(null==a.media.next){$("video").fadeOut(a.param.time,function(){$("#media-video").fadeOut(a.param.time,function(){$("#media").slideUp(a.param.time*2)})})}else{$(a.media.next.self).addClass("playing");$(window).trigger("PlayMedia",{ms:a,target:a.media.next.self})}}}});
$(window).on("SettleDown",function(b,a){$("html, body").animate({scrollTop:0},a.param.time*2);$("#media").hide();$("#content").fadeTo(a.param.time*2,1,function(){a.huds.off();a.lazy.attach("img")})});